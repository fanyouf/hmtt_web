<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <head>
    <style>
      #app {
        width: 300px;
        margin: 10px auto;
        border:1px solid #ccc;
        padding:4px;
      }
      .box{
        margin: .2em;
        padding: .2em;
        border: 1px solid #ccc;
      }
      </style>
  </head>
</head>
<body>
  <div id="app">
    <p>根组件</p>
    <com-a></com-a>
    <com-d></com-d>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/vuex@3.6.0/dist/vuex.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>
    const { mapMutations } = Vuex.createNamespacedHelpers('book')

    Vue.component('com-a',{
      template: `
      <div class="box">
        <p>组件A</p>
        <com-b></com-b>
        <com-c></com-c>
      </div>
      `
    })

    Vue.component('com-b',{
      template: `
      <div class="box">
        <p>组件B</p>
        数据:{{$store.state.num}}
        <button @click="hSetNum10">数据+10</button>
      </div>
      `,
      methods: {
        hSetNum10 () {
          this.$store.commit("add10")
        }
      }
    })
    Vue.component('com-c',{
      template: `
      <div class="box">
        <p>组件C</p>
        数据:{{num2}}
      </div>
      `,
      computed: {
        // ...Vuex.mapState(['num'])
        // ...Vuex.mapState([{'num': 'num2'}])
        ...Vuex.mapState({
          'num2': 'num',
          // 箭头函数可使代码更简练
          count: state => state.num,

          // 为了能够使用 `this` 获取局部状态，必须使用常规函数
          countPlusLocalState (state) {
            return state.num + this.a
          }
        })
      }
    })

    Vue.component('com-d',{
      created () {
        console.dir(this.$store)
        this.$store.dispatch('book/getBooks', {a:1})
      },
      template: `
      <div class="box">
        <p>组件D</p>
        数据:{{$store.state.num}}
        书本:{{$store.state.book.list}}
        <p><button @click="hAddBook">添加书本</button></p>
      </div>
      `,
      methods: {
        hAddBook () {
          // this.$store.commit('addBook', {name: 'test', price: 100})
          this.addBook({name: 'test', price: 100})
        },
        ...mapMutations(['addBook'])
      }
    })
    Vue.use(Vuex)

    const store = new Vuex.Store({
      state: {
        num: 100
      },
      mutations: {
        add10 (state) {
          this.state.num += 10
        },
        addN (state, n) {
          this.state.num += n
        }
      },
      modules: {
        book: {
          namespaced: true,
          state: {
            list: [ {name: '老人与海', price: 89 }]
          },

          mutations: {
            setBook(state, payload) {
              state.list = payload
            },
            addBook(state, {name, price}) {
              state.list.push({name, price})
            }
          },
          actions: {
            getBooks(context, abc) {
              console.log(abc)
              axios({
                methods: 'get',
                url:'https://www.fastmock.site/mock/37d3b9f13a48d528a9339fbed1b81bd5/book/api/books'
              }).then(res => {
                context.commit('setBook', res.data.data)
              })
            }
          }
        }
      }
    })
    new Vue({
      el: "#app",
      store
    })
  </script>
</body>
</html>